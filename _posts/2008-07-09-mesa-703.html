--- 
name: mesa-703
layout: post
time: 2008-07-09 21:32:00 +02:00
title: WMU-6500FS - Mesa 7.0.3
---
Following image demonstrates the <a href="http://www.mesa3d.org/">Mesa 3d</a> application running on the box. As can be seen from FPS, there is no HW acceleration  :-)
<br/>
<br/>
<a onblur="try {parent.deselectBloggerImageGracefully();} catch(e) {}" href="http://3.bp.blogspot.com/_xFBIBcRhwFQ/SFb7YkcsWoI/AAAAAAAABdM/9Cbt9UGNecA/s1600-h/mesa.png"><img style="margin: 0px auto 10px; display: block; text-align: center; cursor: pointer;" src="http://3.bp.blogspot.com/_xFBIBcRhwFQ/SFb7YkcsWoI/AAAAAAAABdM/9Cbt9UGNecA/s400/mesa.png" alt="" id="BLOGGER_PHOTO_ID_5212630018247383682" border="0" /></a>
<br/>
<br/>
<b>Build results (library):</b>
<a href="http://philodej.googlepages.com/Mesa-7.0.3.tar.bz2">[binary]</a>
<a href="http://philodej.googlepages.com/Mesa-7.0.3.lst">[files list]</a>
<br/>
<b>Build results (demos):</b>
<a href="http://philodej.googlepages.com/MesaDemos-7.0.3.tar.bz2">[binary]</a>
<a href="http://philodej.googlepages.com/MesaDemos-7.0.3.lst">[files list]</a>
<br/>
<b>Info sources:</b>
<a href="http://mesa3d.org/">[Home page]</a> 
<a href="http://www.linuxfromscratch.org/blfs/view/svn/x/mesalib.html">[MesaLib dependencies]</a>
<br/>
<b>Related info:</b>
<a href="http://www.straightrunning.com/XmingNotes/">[Xming notes]</a>
<a href="http://digg.com/linux_unix/Remote_Desktop_for_Linux">[Remote desktop for linux]</a>
<a href="http://osdir.com/ml/video.mesa3d.user/2006-03/msg00008.html">[Compiling Mesa fbdev/DRI drivers without X installed]</a>
<br/>
<br/>
For now we try to compile the stand-alone/Xlib mode (no Hardware acceleration necessary ;-)
<br/>
<br/>
<span class="fullpost">
<b>Dependencies:</b>
<a href="http://philodej.googlepages.com/file-4.24.tar.bz2">[file 4.24]</a>
<a href="http://rapidshare.com/files/125380138/x11-7.1.tar.bz2.html">[Xorg libraries]</a>
<br/>
<br/>
First we have to download and extract the libraries and related stuff:
<pre class="code">
dev# cd /usr/local/src
dev# wget "http://downloads.sourceforge.net/mesa3d/MesaLib-7.0.3.tar.bz2?modtime=1207336858&big_mirror=0"
dev# tar xjvf MesaLib-7.0.3.tar.bz2
dev# wget "http://downloads.sourceforge.net/mesa3d/MesaDemos-7.0.3.tar.bz2?modtime=1207336927&big_mirror=0"
dev# tar xjvf MesaDemos-7.0.3.tar.bz2
dev# wget "http://downloads.sourceforge.net/mesa3d/MesaGLUT-7.0.3.tar.bz2?modtime=1207336986&big_mirror=0"
dev# tar xjvf MesaGLUT-7.0.3.tar.bz2 
dev# cd Mesa-7.0.3
</pre>
Now it is necessary to modify the configuration files, we have to replace the following two paths in the <i>configs/linux</i>:
<pre class="code">
dev# nano configs/linux

#X11_INCLUDES = -I/usr/X11R6/include
<b>X11_INCLUDES = -I/mnt/C/sys/X11/include</b>

#EXTRA_LIB_PATH = -L/usr/X11R6/lib
<b>EXTRA_LIB_PATH = -L/mnt/C/sys/X11/lib</b>
</pre>
Also we have to alter the installation paths int the <i>configs/default</i>:
<pre class="code">
dev# nano configs/default

#INSTALL_DIR = /usr/local
<b>INSTALL_DIR = /mnt/C/sys/X11</b>

#DRI_DRIVER_INSTALL_DIR = /usr/X11R6/lib/modules/dri
<b>DRI_DRIVER_INSTALL_DIR = /mnt/C/sys/X11/lib/modules/dri</b>
</pre>
No we are ready build:
<pre class="code">
dev# make linux-x86
...
../../lib/libGL.so: undefined reference to `posix_memalign'
collect2: ld returned 1 exit status
</pre>
Regarding to <a href="http://www.delilinux.org/forum/topic.php?id=252">this forum topic</a> the <i>posix_memalign</i> is currently not 
implemented in <i>uClibc</i> so we have to disable it.
<br/>
So let's back to the configuration file:
<pre class="code">
dev# nano configs/linux

DEFINES = -D_POSIX_SOURCE -D_POSIX_C_SOURCE=199309L -D_SVID_SOURCE \
        -D_BSD_SOURCE -D_GNU_SOURCE \
        -DPTHREADS -DUSE_XSHM
<b># -DHAVE_POSIX_MEMALIGN</b>
</pre>
Now we try the build... 
<pre class="code">
dev# make linux-x86
</pre>
... and it completed successfully. 
<br/>
<br/>
We are ready to start testing some demo apps, we try the notorious <i>gears</i> application:
<pre class="code">
#dev /mnt/C/sys/bin/mesa-demos/gears
</pre>
If you get an error message similar to this:
<pre class="code">
Error: Can't open display:
</pre>
... you probably did not configured the DISPLAY environment variable properly. For a hint how to do that see the 
<a href="http://filodej.blogspot.com/2008/06/wmu-6500fs-box-with-jokers-fw.html#x-config">X client/server configuration</a>.
<br/>
<br/>
We have now the X client/server properly configured, <i>gears</i> test passed with no problems, we are ready to deploy on the box.
<br/>
Curiously on the box we observe the following crash:
<pre class="code">
box# /mnt/C/sys/bin/mesa-demos/gears
Illegal instruction
</pre>
To get to the heart of the matter we have to digg little deeper, however we need a tool for it. Let's try JoKeR's built version of gdb. For now we are going to debug directly at the box, later on we look at the remote debugging.
<pre class="code">
box# <b>gdb /mnt/C/sys/bin/mesa-demos/gears</b>
GNU gdb 6.3
Copyright 2004 Free Software Foundation, Inc.
GDB is free software, covered by the GNU General Public License, and you are
welcome to change it and/or distribute copies of it under certain conditions.
Type "show copying" to see the conditions.
There is absolutely no warranty for GDB.  Type "show warranty" for details.
This GDB was configured as "i386-linux-uclibc"...Using host libthread_db library "/mnt/C/sys/lib/libthread_db.so.1".

(gdb) <b>run</b>
Starting program: /tmp/mnt/C/sys/bin/mesa-demos/gears
warning: Cannot initialize thread debugging library: generic error


Program received signal SIGILL, Illegal instruction.
_mesa_x86_cpuid () at x86/common_x86_asm.S:80
80      x86/common_x86_asm.S: No such file or directory.
        in x86/common_x86_asm.S
Current language:  auto; currently asm
(gdb) <b>backtrace</b>
#0  _mesa_x86_cpuid () at x86/common_x86_asm.S:80
#1  0x403053f0 in ?? () from /mnt/C/sys/lib/libGL.so.1
#2  0x4031f980 in quad_tab () from /mnt/C/sys/lib/libGL.so.1
#3  0x4021c24a in _mesa_init_all_x86_transform_asm () at x86/common_x86.c:180
#4  0x4016a17d in _math_init_transformation () at math/m_xform.c:214
#5  0x4016a19a in _math_init () at math/m_xform.c:227
#6  0x400e8674 in one_time_init (ctx=0x8056b38) at main/context.c:368
#7  0x400e75e1 in _mesa_initialize_context (ctx=0x8056b38, visual=0x8054688,
    share_list=0x0, driverFunctions=0xbffff6c0, driverContext=0x0) at main/context.c:1067
#8  0x4026f92b in XMesaCreateContext (v=0x8054688, share_list=0x0)
    at drivers/x11/xm_api.c:1504
#9  0x4026c234 in Fake_glXCreateContext (dpy=0x804cfa0, visinfo=0x8056900,
    share_list=0x0, direct=1) at drivers/x11/fakeglx.c:1401
#10 0x4026a46d in glXCreateContext (dpy=0x804cfa0, visinfo=0x8056900, shareList=0x0,
    direct=1) at drivers/x11/glxapi.c:188
#11 0x40020d22 in __glutCreateWindow (parent=0x0, x=0, y=0, width=300,
    height=1073998032, gameMode=0) at glut_win.c:609
#12 0x40020df3 in glutCreateWindow (title=0x804ae60 "Gears") at glut_win.c:731
#13 0x0804902e in main (argc=1, argv=0xbffffbc4) at gears.c:370
(gdb)
</pre>
Ok, it seems promising, now we can look at the file in question:
<pre class="code">
dev# less /usr/local/src/Mesa-7.0.3/src/mesa/x86/common_x86_asm.S
</pre>
... or we can look for example <a href="http://webcvs.freedesktop.org/mesa/Mesa/src/mesa/x86/common_x86_asm.S?annotate=1.20">here</a> 

on the web. At the line 80 we see the CPUID instruction:
<pre class="code">
...
76 :  MOV_L (REGOFF(4, ESP), EAX) /* cpuid op */
77 :  PUSH_L (EDI)
78 :  PUSH_L (EBX)
79 :  
<b>80 :  CPUID</b>
81 :  
82 :  MOV_L (REGOFF(16, ESP), EDI) /* *eax */
83 :  MOV_L (EAX, REGIND(EDI))
...
</pre>
At the <a href="http://en.wikipedia.org/wiki/CPUID">CPUID instruction description</a> we can see what exactly the this instruction means and when it was introduced.
<br/>
The following way we can find out the exact info about the CPU in the box:
<pre class="code">
box# cat /proc/cpuinfo
processor       : 0
vendor_id       : CyrixInstead
cpu family      : 4
model           : 1
model name      : <b>Cx486SLC</b>
stepping        : unknown
fdiv_bug        : no
hlt_bug         : no
f00f_bug        : no
coma_bug        : no
fpu             : no
fpu_exception   : no
cpuid level     : -1
wp              : yes
flags           :
bogomips        : 44.33
</pre>
In the document <a href="http://datasheets.chipdb.org/Cyrix/112ap.pdf">Application Note112 CyrixCPU Detection Guide</a> I have found the 

following info:
<br/>
<blockquote>
<i>The <b>Cx486SLC</b>, Cx486DLC, Cx486SRx2, Cx486DRx2, Cx486S, Cx486DX, Cx486DX2, and 5x86
processors do not recognize the CPUID instruction and must be identified using the DIR0 and DIR1 register.</i>
</blockquote>
So the cause of the problem is found. There is no support of certain instructions on the box and so we cannot be sure the code we built on the PC will run. 
<br/>
In the configuration file <i>configs/linux-x86</i> we can see following ASM related switches:
<pre class="code">
ASM_FLAGS = -DUSE_X86_ASM -DUSE_MMX_ASM -DUSE_3DNOW_ASM -DUSE_SSE_ASM
</pre>
In order not to use ASM implementations we can use <i>linux</i> configuration instead of <i>linux-x86</i>:
<pre class="code">
dev# make realclean
dev# make linux
</pre>
Everything seem to be working now :-)
</span><div class="blogger-post-footer"><img width='1' height='1' src='https://blogger.googleusercontent.com/tracker/183431720687819497-1986414273935104839?l=filodej.blogspot.com' alt='' /></div>
